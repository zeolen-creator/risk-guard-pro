import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { supabase } from "@/integrations/supabase/client";
import { useProfile } from "./useProfile";
import { toast } from "sonner";
import type { Json } from "@/integrations/supabase/types";

export interface VulnerabilityFactors {
  elderly_population_pct: number;
  infrastructure_age_years: number;
  emergency_capacity: "low" | "medium" | "high";
  poverty_rate_pct: number;
  healthcare_access: "poor" | "limited" | "good" | "excellent";
  communication_infrastructure: "poor" | "limited" | "good" | "excellent";
}

const DEFAULT_FACTORS: VulnerabilityFactors = {
  elderly_population_pct: 0,
  infrastructure_age_years: 0,
  emergency_capacity: "medium",
  poverty_rate_pct: 0,
  healthcare_access: "good",
  communication_infrastructure: "good",
};

export function useVulnerabilityFactors() {
  const { data: profile } = useProfile();

  return useQuery({
    queryKey: ["vulnerability-factors", profile?.org_id],
    queryFn: async (): Promise<VulnerabilityFactors> => {
      if (!profile?.org_id) return DEFAULT_FACTORS;

      const { data, error } = await supabase
        .from("organizations")
        .select("vulnerability_factors")
        .eq("id", profile.org_id)
        .single();

      if (error) throw error;
      return (data?.vulnerability_factors as unknown as VulnerabilityFactors) || DEFAULT_FACTORS;
    },
    enabled: !!profile?.org_id,
  });
}

export function useUpdateVulnerabilityFactors() {
  const queryClient = useQueryClient();
  const { data: profile } = useProfile();

  return useMutation({
    mutationFn: async (factors: VulnerabilityFactors) => {
      if (!profile?.org_id) throw new Error("No organization");

      const { error } = await supabase
        .from("organizations")
        .update({ vulnerability_factors: factors as unknown as Json })
        .eq("id", profile.org_id);

      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["vulnerability-factors"] });
      toast.success("Vulnerability factors saved");
    },
  });
}

// Calculate overall vulnerability score (0-100)
export function calculateVulnerabilityScore(factors: VulnerabilityFactors): number {
  let score = 0;
  
  // Elderly population (0-25 points)
  score += Math.min(25, factors.elderly_population_pct);
  
  // Infrastructure age (0-20 points)
  score += Math.min(20, factors.infrastructure_age_years * 0.4);
  
  // Emergency capacity (0-15 points)
  const emergencyScores = { low: 15, medium: 8, high: 0 };
  score += emergencyScores[factors.emergency_capacity] || 8;
  
  // Poverty rate (0-15 points)
  score += Math.min(15, factors.poverty_rate_pct * 0.5);
  
  // Healthcare access (0-15 points)
  const healthcareScores = { poor: 15, limited: 10, good: 5, excellent: 0 };
  score += healthcareScores[factors.healthcare_access] || 5;
  
  // Communication infrastructure (0-10 points)
  const commScores = { poor: 10, limited: 7, good: 3, excellent: 0 };
  score += commScores[factors.communication_infrastructure] || 3;
  
  return Math.min(100, Math.round(score));
}

// Get vulnerability level from score
export function getVulnerabilityLevel(score: number): {
  level: "Low" | "Moderate" | "High" | "Very High";
  color: string;
  description: string;
} {
  if (score < 25) {
    return {
      level: "Low",
      color: "text-green-600",
      description: "Organization has strong resilience factors",
    };
  }
  if (score < 50) {
    return {
      level: "Moderate",
      color: "text-yellow-600",
      description: "Some vulnerability factors present",
    };
  }
  if (score < 75) {
    return {
      level: "High",
      color: "text-orange-600",
      description: "Significant vulnerability factors require attention",
    };
  }
  return {
    level: "Very High",
    color: "text-red-600",
    description: "Critical vulnerability factors need immediate action",
  };
}

// Calculate vulnerability-adjusted risk score
export function getVulnerabilityAdjustedScore(
  baseScore: number,
  vulnerabilityScore: number
): number {
  // Vulnerability adds up to 50% to the risk score
  const multiplier = 1 + (vulnerabilityScore / 200);
  return Math.min(20, Math.round(baseScore * multiplier));
}
